<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Where did I go</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script>

  <style>
    body { margin: 0; padding: 0; }
    /* === é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ === */
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background-color: #1e293b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-family: sans-serif;
      z-index: 1000;
    }

    #navbar .nav-left .logo {
      font-weight: bold;
      font-size: 18px;
    }

    #navbar .nav-center a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      font-size: 15px;
    }

    #navbar .nav-center a:hover {
      text-decoration: underline;
    }

    #navbar .nav-right select {
      background-color: #1e293b;
      color: white;
      border: 1px solid #475569;
      border-radius: 4px;
      padding: 3px 6px;
    }

    /* === åœ°å›¾å®¹å™¨åç§»ï¼ˆé¿å…è¢«å¯¼èˆªæ é®æŒ¡ï¼‰ === */
    #map {
      height: calc(100vh - 50px);
      width: 100%;
      margin-top: 50px; /* ç•™å‡ºå¯¼èˆªæ é«˜åº¦ */
    }
  </style>
</head>
<body>

<nav id="navbar">
  <div class="nav-left">
    <span class="logo" data-i18n="title">ğŸŒ Where did I go</span>
  </div>

  <div class="nav-center">
    <a href="index.html" data-i18n="nav.home">Home</a>
    <a href="flights.html" data-i18n="nav.flights">Flights</a>
    <a href="railway.html" data-i18n="nav.railway">Railways</a>
    <a href="points.html" data-i18n="nav.points">Landmarks</a>
  </div>

  <div class="nav-right">
    <select id="langSelect">
      <option value="zh">ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
  </div>
</nav>

<div id="map"></div>

<script>

  // 1ï¸âƒ£ è·å– URL å‚æ•°
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // 2ï¸âƒ£ åˆå§‹åŒ–è¯­è¨€
  let currentLang = getQueryParam("lang") || localStorage.getItem("lang") || "zh";
  localStorage.setItem("lang", currentLang);

  // è®¾ç½®ä¸‹æ‹‰æ¡†é€‰ä¸­
  document.getElementById("langSelect").value = currentLang;

  // 3ï¸âƒ£ åŠ è½½è¯­è¨€ JSON å¹¶æ›´æ–°æ–‡æœ¬
  async function loadLanguage(lang) {
    try {
      const resp = await fetch("lang.json");
      const data = await resp.json();
      const dict = data[lang] || data["zh"];

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const keys = el.dataset.i18n.split(".");
        let value = dict;
        for (const key of keys) value = value ? value[key] : null;
        if (value) el.textContent = value;
      });
    } catch (err) {
      console.error("è¯­è¨€æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
    }
  }

  loadLanguage(currentLang);

  // 4ï¸âƒ£ åˆ‡æ¢è¯­è¨€æ—¶æ›´æ–° URLï¼ˆåˆ·æ–°é¡µé¢ï¼‰
  document.getElementById("langSelect").addEventListener("change", e => {
    const newLang = e.target.value;
    localStorage.setItem("lang", newLang);

    // åˆ·æ–°é¡µé¢å¹¶å¸¦ä¸Š ?lang å‚æ•°
    const newUrl = `${window.location.pathname}?lang=${newLang}`;
    window.location.href = newUrl;
  });

  const map = L.map("map").setView([31, 121], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors',
  }).addTo(map);

  const groups = {
    flights: { color: "blue", files: ['./flights/gpx/Variflight_8L9518_20250908.gpx', './flights/gpx/Variflight_9C6363_20250301.gpx', './flights/gpx/Variflight_9C6998_20250304.gpx', './flights/gpx/Variflight_9C8909_20241109.gpx', './flights/gpx/Variflight_9H8403_20250909.gpx', './flights/gpx/Variflight_CA1550_20240611.gpx', './flights/gpx/Variflight_CA1829_20240611.gpx', './flights/gpx/Variflight_CA952_20250216.gpx', './flights/gpx/Variflight_CZ2308_20250528.gpx', './flights/gpx/Variflight_CZ3533_20250427.gpx', './flights/gpx/Variflight_CZ6252_20250606.gpx', './flights/gpx/Variflight_CZ6257_20250609.gpx', './flights/gpx/Variflight_CZ6521_20250220.gpx', './flights/gpx/Variflight_CZ6525_20241007.gpx', './flights/gpx/Variflight_CZ6526_20241001.gpx', './flights/gpx/Variflight_CZ6526_20250219.gpx', './flights/gpx/Variflight_CZ6536_20250214.gpx', './flights/gpx/Variflight_CZ6697_20250420.gpx', './flights/gpx/Variflight_CZ6909_20250603.gpx', './flights/gpx/Variflight_CZ7054_20250815.gpx', './flights/gpx/Variflight_CZ8264_20250418.gpx', './flights/gpx/Variflight_CZ8839_20241021.gpx', './flights/gpx/Variflight_CZ8879_20241104.gpx', './flights/gpx/Variflight_CZ8879_20241202.gpx', './flights/gpx/Variflight_CZ8880_20241129.gpx', './flights/gpx/Variflight_CZ8886_20250411.gpx', './flights/gpx/Variflight_CZ8886_20250515.gpx', './flights/gpx/Variflight_CZ8888_20241220.gpx', './flights/gpx/Variflight_CZ8889_20241222.gpx', './flights/gpx/Variflight_CZ888R_20241102.gpx', './flights/gpx/Variflight_CZ8899_20250604.gpx', './flights/gpx/Variflight_FM823_20250529.gpx', './flights/gpx/Variflight_FM9224_20251018.gpx', './flights/gpx/Variflight_FM9426_20251204.gpx', './flights/gpx/Variflight_FM9525_20251205.gpx', './flights/gpx/Variflight_G54818_20250820.gpx', './flights/gpx/Variflight_GS6697_20250915.gpx', './flights/gpx/Variflight_GS7827_20251130.gpx', './flights/gpx/Variflight_GS7974_20250912.gpx', './flights/gpx/Variflight_GS7983_20250910.gpx', './flights/gpx/Variflight_GX8960_20251026.gpx', './flights/gpx/Variflight_HO2348_20240719.gpx', './flights/gpx/Variflight_HU7136_20251114.gpx', './flights/gpx/Variflight_HU7145_20251013.gpx', './flights/gpx/Variflight_HU7246_20251011.gpx', './flights/gpx/Variflight_HU7609_20251117.gpx', './flights/gpx/Variflight_HU7610_20251107.gpx', './flights/gpx/Variflight_HU7678_20251126.gpx', './flights/gpx/Variflight_HU7705_20240606.gpx', './flights/gpx/Variflight_JD5314_20251028.gpx', './flights/gpx/Variflight_JD5550_20240712.gpx', './flights/gpx/Variflight_JD5908_20251110.gpx', './flights/gpx/Variflight_KN2905_20250217.gpx', './flights/gpx/Variflight_MU2039_20250808.gpx', './flights/gpx/Variflight_MU2074_20250530.gpx', './flights/gpx/Variflight_MU2191_20250502.gpx', './flights/gpx/Variflight_MU2192_20250502.gpx', './flights/gpx/Variflight_MU2216_20250316.gpx', './flights/gpx/Variflight_MU2233_20250315.gpx', './flights/gpx/Variflight_MU2239_20250317.gpx', './flights/gpx/Variflight_MU2350_20250909.gpx', './flights/gpx/Variflight_MU5052_20250808.gpx', './flights/gpx/Variflight_MU5152_20250414.gpx', './flights/gpx/Variflight_MU5296_20250106.gpx', './flights/gpx/Variflight_MU5308_20250916.gpx', './flights/gpx/Variflight_MU5319_20250426.gpx', './flights/gpx/Variflight_MU5417_20250102.gpx', './flights/gpx/Variflight_MU5428_20250529.gpx', './flights/gpx/Variflight_MU5523_20250806.gpx', './flights/gpx/Variflight_MU6128_20250713.gpx', './flights/gpx/Variflight_MU6135_20250502.gpx', './flights/gpx/Variflight_MU6337_20250808.gpx', './flights/gpx/Variflight_MU6357_20250710.gpx', './flights/gpx/Variflight_MU6513_20250909.gpx', './flights/gpx/Variflight_MU6514_20250909.gpx', './flights/gpx/Variflight_MU6582_20250714.gpx', './flights/gpx/Variflight_MU6873_20250824.gpx', './flights/gpx/Variflight_MU6939_20250918.gpx', './flights/gpx/Variflight_MU720_20250314.gpx', './flights/gpx/Variflight_MU8342_20250518.gpx', './flights/gpx/Variflight_MU9205_20241228.gpx', './flights/gpx/Variflight_MU9851_20250603.gpx', './flights/gpx/Variflight_PN6214_20251202.gpx', './flights/gpx/Variflight_PN6260_20250904.gpx', './flights/gpx/Variflight_PN6271_20250905.gpx']
    },
  };

  const icons = {
    flights: L.icon({
      iconUrl: "assets/airport.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    }),
  };

  const overlays = {};  // æ¯ä¸ªæ–‡ä»¶å¤¹ä¸€ç»„å›¾å±‚
  let globalBounds = null;
  let allGpxLayers = []; // ç”¨äºåç»­æ›´æ–°è¯­è¨€
  let langMap = {};

  let total = 85;
  let loaded = 0;

  loadAllGpx();
  // === åŠ è½½ GPX æ–‡ä»¶ ===
  function loadAllGpx() {
    for (const [folder, cfg] of Object.entries(groups)) {
      const layerGroup = L.layerGroup();
      overlays[folder] = layerGroup;

      cfg.files.forEach(file => {
        const gpx = new L.GPX(file, {
          async: true,
          polyline_options: {
            color: cfg.color,
            weight: 4,
            opacity: 0.8
          },
          markers: { startIcon: null, endIcon: null }
        })
        .on("loaded", e => {
          const g = e.target;
          const filename = file.split("/").pop().replace(".gpx", "");
          let displayName;

          // === flights ä½¿ç”¨åŸæ–‡ä»¶å ===
          const match = filename.match(/_(\w+)_([0-9]{8})$/);

          if (match) {
            displayName = `${match[2]}-${match[1]}`;
          } else {
            displayName = filename.replace(".gpx", "");
          }

          g._filename = filename;
          g.bindPopup(`<b>${displayName}</b>`);
          allGpxLayers.push(g);

          // === è°ƒæ•´è§†å›¾èŒƒå›´ ===
          const b = g.getBounds();
          if (globalBounds) globalBounds.extend(b);
          else globalBounds = b;

          loaded ++;
          if (loaded === total) {
            map.fitBounds(globalBounds, { padding: [20, 20] });
          }
        })
        .addTo(layerGroup);
      });
    }
    
    overlays.flights.addTo(map);
  }

  fetch("./flights/airport.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue; // æ²¡æœ‰å¯¹åº”ç»„åˆ™è·³è¿‡

        points.forEach(p => {
          const name = currentLang === "zh" ? p.name_zh : p.name_en;
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${name}</b>`)
            .addTo(group);
        // ä¸ºåç»­è¯­è¨€åˆ‡æ¢ä¿å­˜å¼•ç”¨
        marker._names = { zh: p.name_zh, en: p.name_en };
        if (!group._markers) group._markers = [];
          group._markers.push(marker);
        });
      }
    })
  .catch(err => console.error("åŠ è½½ airport.json å‡ºé”™:", err));


  function updateMarkerLang(lang) {
    if (!map._markers) return;
    map._markers.forEach(marker => {
      marker.bindPopup(`<b>${marker._names[lang]}</b>`);
    });
  };

  function updateGpxLang(lang) {
    allGpxLayers.forEach(g => {
      const name = langMap[g._filename]?.[lang] || g._filename;
      g.bindPopup(`<b>${name}</b>`);
    });
  }

  // ç›‘å¬è¯­è¨€å˜åŒ–å¹¶æ›´æ–° popup
  window.addEventListener("storage", e => {
    if (e.key === "lang") {
      loadLanguage(e.newValue);
      updateMarkerLang(e.newValue);
      updateGpxLang(e.newValue);
    }
  });

</script>

</body>
</html>
