<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Where did I go</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="css/railway_legend.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script>

  <style>
    body { margin: 0; padding: 0; }
    /* === é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ === */
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background-color: #1e293b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-family: sans-serif;
      z-index: 1000;
    }

    #navbar .nav-left .logo {
      font-weight: bold;
      font-size: 18px;
    }

    #navbar .nav-center a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      font-size: 15px;
    }

    #navbar .nav-center a:hover {
      text-decoration: underline;
    }

    #navbar .nav-right select {
      background-color: #1e293b;
      color: white;
      border: 1px solid #475569;
      border-radius: 4px;
      padding: 3px 6px;
    }

    /* === åœ°å›¾å®¹å™¨åç§»ï¼ˆé¿å…è¢«å¯¼èˆªæ é®æŒ¡ï¼‰ === */
    #map {
      height: calc(100vh - 50px);
      width: 100%;
      margin-top: 50px; /* ç•™å‡ºå¯¼èˆªæ é«˜åº¦ */
    }
  </style>
</head>
<body>

<nav id="navbar">
  <div class="nav-left">
    <span class="logo" data-i18n="title">ğŸŒ Where did I go</span>
  </div>

  <div class="nav-center">
    <a href="index.html" data-i18n="nav.home">Home</a>
    <a href="flights.html" data-i18n="nav.flights">Flights</a>
    <a href="railway.html" data-i18n="nav.railway">Railways</a>
    <a href="points.html" data-i18n="nav.points">Landmarks</a>
  </div>

  <div class="nav-right">
    <select id="langSelect">
      <option value="zh">ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
  </div>
</nav>

<div id="map"></div>

<script>

  // 1ï¸âƒ£ è·å– URL å‚æ•°
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // 2ï¸âƒ£ åˆå§‹åŒ–è¯­è¨€
  let currentLang = getQueryParam("lang") || localStorage.getItem("lang") || "zh";
  localStorage.setItem("lang", currentLang);

  // è®¾ç½®ä¸‹æ‹‰æ¡†é€‰ä¸­
  document.getElementById("langSelect").value = currentLang;

  // 3ï¸âƒ£ åŠ è½½è¯­è¨€ JSON å¹¶æ›´æ–°æ–‡æœ¬
  async function loadLanguage(lang) {
    try {
      const resp = await fetch("lang.json");
      const data = await resp.json();
      const dict = data[lang] || data["zh"];

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const keys = el.dataset.i18n.split(".");
        let value = dict;
        for (const key of keys) value = value ? value[key] : null;
        if (value) el.textContent = value;
      });
    } catch (err) {
      console.error("è¯­è¨€æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
    }
  }

  loadLanguage(currentLang);

  // 4ï¸âƒ£ åˆ‡æ¢è¯­è¨€æ—¶æ›´æ–° URLï¼ˆåˆ·æ–°é¡µé¢ï¼‰
  document.getElementById("langSelect").addEventListener("change", e => {
    const newLang = e.target.value;
    localStorage.setItem("lang", newLang);

    // åˆ·æ–°é¡µé¢å¹¶å¸¦ä¸Š ?lang å‚æ•°
    const newUrl = `${window.location.pathname}?lang=${newLang}`;
    window.location.href = newUrl;
  });

  const map = L.map("map").setView([31, 121], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors',
  }).addTo(map);

  const hsr350Style = { color: "rgb(204,0,0)", weight: 6, opacity: 1.0 };
  const hsr300Style = { color: "rgb(255,100,0)", weight: 6, opacity: 1.0 };
  const hsr250Style = { color: "rgb(255,180,0)", weight: 6, opacity: 1.0 };

  const mainLine200Style = { color: "rgb(96,192,24)", weight: 5, opacity: 1.0 };
  const mainLine160Style = { color: "rgb(64,192,124)", weight: 5, opacity: 1.0 };
  const mainLine120Style = { color: "rgb(24,192,204)", weight: 5, opacity: 1.0 };
  
  const branchLine160Style = { color: "rgb(204, 175, 100)", weight: 4, opacity: 1.0 };
  const branchLine120Style = { color: "rgb(20,82,204)", weight: 4, opacity: 1.0 };

  const linkLineStyle = { color: "rgb(0,0,0)", weight: 3, opacity: 1.0 };

  const legendI18n = {
    zh: {
      title: "çº¿è·¯ç­‰çº§",
      hsr350: "350+km/h é«˜é€Ÿé“è·¯",
      hsr300: "300 km/h é«˜é€Ÿé“è·¯",
      hsr250: "250 km/h é«˜é€Ÿé“è·¯",
      main200: "200 km/h å¿«é€Ÿé“è·¯",
      main160: "160 km/h å¹²çº¿é“è·¯",
      main120: "120 km/h å¹²çº¿é“è·¯",
      branch160: "æ¢çº½çº¿è·¯/åŸé™…é“è·¯",
      branch120: "120 km/h æ”¯çº¿é“è·¯",
      link: "è”ç»œçº¿/å…¶ä»–"
    },
    en: {
      title: "Railway Types",
      hsr350: "350 km/h High-speed Line",
      hsr300: "300 km/h High-speed Line",
      hsr250: "250 km/h High-speed Line",
      main200: "200 km/h Rapid Line",
      main160: "160 km/h Main Line",
      main120: "120 km/h Main Line",
      branch160: "160 km/h Branch Line",
      branch120: "120 km/h Branch Line",
      link: "Link Line / Other"
    }
  };

  const legendItems = [
    { key: "hsr350", style: hsr350Style },
    { key: "hsr300", style: hsr300Style },
    { key: "hsr250", style: hsr250Style },

    { key: "main200", style: mainLine200Style },
    { key: "main160", style: mainLine160Style },
    { key: "main120", style: mainLine120Style },

    { key: "branch160", style: branchLine160Style },
    { key: "branch120", style: branchLine120Style },

    { key: "link", style: linkLineStyle }
  ];

  const legend = L.control({ position: "bottomleft" });

  legend.onAdd = function () {
    const div = L.DomUtil.create("div", "map-legend");

    renderLegend(div);

    // é˜²æ­¢æ‹–åŠ¨åœ°å›¾
    L.DomEvent.disableClickPropagation(div);

    return div;
  };

  legend.addTo(map);

  function renderLegend(container) {
    const t = legendI18n[currentLang];

    container.innerHTML = `
      <div class="legend-header">
        <span class="legend-title">${t.title}</span>
        <span class="legend-toggle">â–¾</span>
      </div>
      <div class="legend-content">
        ${legendItems.map(item => {
          const s = item.style;
          return `
            <div class="legend-item">
              <span class="legend-line"
                    style="background:${s.color}; height:${s.weight}px"></span>
              <span class="legend-label">${t[item.key]}</span>
            </div>
          `;
        }).join("")}
      </div>
    `;

    // æŠ˜å é€»è¾‘
    const header = container.querySelector(".legend-header");
    header.onclick = () => {
      container.classList.toggle("collapsed");
    };
  }


  const icons = {
    railway: L.icon({
      iconUrl: "assets/station.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    })
  };

  const overlays = {};
  let globalBounds = null;
  let allGpxLayers = []; // ç”¨äºåç»­æ›´æ–°è¯­è¨€

  let total = 222;
  let loaded = 0;
  let gpxs = [];

  // === åŠ è½½è‹±æ–‡åç§°æ˜ å°„ ===
  fetch("railway/railway.json")
    .then(resp => resp.json())
    .then(data => {
      gpxs = data;
      loadAllRailwayGpx(gpxs);
    })
    .catch(err => {
      console.warn("è¯­è¨€æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡ä»¶åã€‚", err);
    });


  function loadAllRailwayGpx(gpxs) {

    const layerGroup = L.layerGroup();
    overlays["railway"] = layerGroup;

    for (const [filename, p] of Object.entries(gpxs)) {
      const file = "./railway/gpx/" + filename + ".gpx";
      const gpx = new L.GPX(file, {
        async: true,
        markers: { startIcon: null, endIcon: null }
      })
      .on("loaded", e => {
        const g = e.target;
        let displayName;

        // === ä» railway.json å–è‹±æ–‡åç§° ===
        if (!gpxs[filename]) {
          console.warn(`âš ï¸ æœªæ‰¾åˆ° ${filename} çš„å¤šè¯­è¨€æ¡ç›®`);
        }
        displayName = gpxs[filename]?.[currentLang] || filename;

        g._filename = filename;

        let speed = Number(p.speed);

        if (speed >= 250) {
          if (speed >= 350) {
            g._w = 6.001;
            g.setStyle(hsr350Style);
          } else if (speed >= 300) {
            g._w = 6.0;
            g.setStyle(hsr300Style);
          } else {
            g._w = 5.999;
            g.setStyle(hsr250Style);
          }

        } else if (p.type == "main") {
          if (speed >= 200) {
            g._w = 5.001;
            g.setStyle(mainLine200Style);
          } else if (speed >= 160) {
            g._w = 5.0;
            g.setStyle(mainLine160Style);
          } else {
            g._w = 4.999;
            g.setStyle(mainLine120Style);
          }

        } else if (p.type == "branch") {
          if (speed >= 160) {
            g._w = 4.001;
            g.setStyle(branchLine160Style);
          } else {
            g._w = 4.0;
            g.setStyle(branchLine120Style);
          }

        } else {

          g._w = 3;
          g.setStyle(linkLineStyle);
          
        }

        g.bindPopup(`<b>${displayName}</b>`);


        allGpxLayers.push(g);
        g.on("click", e => {
          L.DomEvent.stopPropagation(e);
          highlightGpx(g);
        });
        g.setStyle({opacity: 0.8, weight: g._w});

        // === è°ƒæ•´è§†å›¾èŒƒå›´ ===
        const b = g.getBounds();
        if (globalBounds) globalBounds.extend(b);
        else globalBounds = b;

        loaded ++;
        if (loaded === total) {
          map.fitBounds(globalBounds, { padding: [20, 20] });
          allGpxLayers.sort((a, b) => a._w - b._w);
          resetHighlight();
        }
      })
      .addTo(layerGroup);
    }
    overlays["railway"].addTo(map);

  }

  function highlightGpx(target) {
    activeGpx = target;

    allGpxLayers.forEach(g => {
      if (g === target) {
        g.setStyle({opacity: 1.0, weight: g._w * 2});
        g.bringToFront();
      } else {
        g.setStyle({opacity: 0.25, weight: g._w});
      }
    });
  }

  map.on("click", () => resetHighlight());

  function resetHighlight() {
    activeGpx = null;
    allGpxLayers.forEach(g => {
      g.setStyle({opacity: 0.8, weight: g._w});
      g.bringToFront();
    });
  }

  fetch("./railway/station.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue;

        points.forEach(p => {
          const name = currentLang === "zh" ? p.name_zh : p.name_en;
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${name}</b>`)
            .addTo(group);
          // ä¸ºåç»­è¯­è¨€åˆ‡æ¢ä¿å­˜å¼•ç”¨
          marker._names = { zh: p.name_zh, en: p.name_en };
          if (!group._markers) group._markers = [];
            group._markers.push(marker);
        });
      }
    })
  .catch(err => console.error("åŠ è½½ station.json å‡ºé”™:", err));

  // è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–° Popup

  function updateMarkerLang(lang) {
    if (!map._markers) return;
    map._markers.forEach(marker => {
      marker.bindPopup(`<b>${marker._names[lang]}</b>`);
    });
  };

  function updateGpxLang(lang) {
    allGpxLayers.forEach(g => {
      const name = langMap[g._filename]?.[lang] || g._filename;
      g.bindPopup(`<b>${name}</b>`);
    });
  }

  function updateLegendLang(lang) {
    // æ›´æ–° legend
    const legendEl = document.querySelector(".map-legend");
    if (legendEl) {
      renderLegend(legendEl);
    }
  }

  // ç›‘å¬è¯­è¨€å˜åŒ–å¹¶æ›´æ–° popup
  window.addEventListener("storage", e => {
    if (e.key === "lang") {
      loadLanguage(e.newValue);
      updateMarkerLang(e.newValue);
      updateGpxLang(e.newValue);
    }
  });

</script>

</body>
</html>
