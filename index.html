<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Where did I go</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

<script>
  const map = L.map("map").setView([31, 121], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors',
  }).addTo(map);

  const groups = {
    flights: { color: "blue", files: ['./flights/Variflight_8L9518_20250908.gpx', './flights/Variflight_9C6363_20250301.gpx', './flights/Variflight_9C6998_20250304.gpx', './flights/Variflight_9C8909_20241108.gpx', './flights/Variflight_9H8403_20250909.gpx', './flights/Variflight_CA1550_20240611.gpx', './flights/Variflight_CA1829_20240611.gpx', './flights/Variflight_CA952_20250216.gpx', './flights/Variflight_CZ2308_20250528.gpx', './flights/Variflight_CZ3533_20250426.gpx', './flights/Variflight_CZ6252_20250606.gpx', './flights/Variflight_CZ6257_20250608.gpx', './flights/Variflight_CZ6521_20250219.gpx', './flights/Variflight_CZ6525_20241007.gpx', './flights/Variflight_CZ6526_20241001.gpx', './flights/Variflight_CZ6526_20250219.gpx', './flights/Variflight_CZ6536_20250214.gpx', './flights/Variflight_CZ6697_20250420.gpx', './flights/Variflight_CZ6909_20250603.gpx', './flights/Variflight_CZ7054_20250815.gpx', './flights/Variflight_CZ8264_20250418.gpx', './flights/Variflight_CZ8839_20241021.gpx', './flights/Variflight_CZ8879_20241104.gpx', './flights/Variflight_CZ8879_20241202.gpx', './flights/Variflight_CZ8880_20241129.gpx', './flights/Variflight_CZ8886_20250411.gpx', './flights/Variflight_CZ8886_20250515.gpx', './flights/Variflight_CZ8888_20241220.gpx', './flights/Variflight_CZ8889_20241222.gpx', './flights/Variflight_CZ888R_20241102.gpx', './flights/Variflight_CZ8899_20250604.gpx', './flights/Variflight_FM823_20250529.gpx', './flights/Variflight_G54818_20250820.gpx', './flights/Variflight_GS6697_20250915.gpx', './flights/Variflight_GS7974_20250912.gpx', './flights/Variflight_GS7983_20250910.gpx', './flights/Variflight_HO2348_20240719.gpx', './flights/Variflight_HU7705_20240606.gpx', './flights/Variflight_JD5550_20240712.gpx', './flights/Variflight_KN2905_20250216.gpx', './flights/Variflight_MU2039_20250807.gpx', './flights/Variflight_MU2074_20250530.gpx', './flights/Variflight_MU2191_20250502.gpx', './flights/Variflight_MU2192_20250502.gpx', './flights/Variflight_MU2216_20250316.gpx', './flights/Variflight_MU2233_20250315.gpx', './flights/Variflight_MU2239_20250316.gpx', './flights/Variflight_MU2350_20250909.gpx', './flights/Variflight_MU5052_20250808.gpx', './flights/Variflight_MU5152_20250414.gpx', './flights/Variflight_MU5296_20250105.gpx', './flights/Variflight_MU5308_20250916.gpx', './flights/Variflight_MU5319_20250426.gpx', './flights/Variflight_MU5417_20250102.gpx', './flights/Variflight_MU5428_20250529.gpx', './flights/Variflight_MU5523_20250806.gpx', './flights/Variflight_MU6128_20250713.gpx', './flights/Variflight_MU6135_20250502.gpx', './flights/Variflight_MU6337_20250808.gpx', './flights/Variflight_MU6357_20250710.gpx', './flights/Variflight_MU6513_20250908.gpx', './flights/Variflight_MU6514_20250909.gpx', './flights/Variflight_MU6582_20250713.gpx', './flights/Variflight_MU6873_20250824.gpx', './flights/Variflight_MU6939_20250917.gpx', './flights/Variflight_MU720_20250314.gpx', './flights/Variflight_MU8342_20250518.gpx', './flights/Variflight_MU9205_20241227.gpx', './flights/Variflight_MU9851_20250603.gpx', './flights/Variflight_PN6260_20250904.gpx', './flights/Variflight_PN6271_20250905.gpx']
    },
    railway: { color: "green", files: ['./railway/上海南联络线（沪春一二线）.gpx', './railway/上海南联络线（沪春三四线）.gpx', './railway/上饶东南联络线.gpx', './railway/东新联络线（东门-新香坊）.gpx', './railway/东星线（北京东-北京朝阳）.gpx', './railway/京九线（南昌-向塘-三江镇）.gpx', './railway/京九线（黄土坡线路所-乐化）.gpx', './railway/京包-包兰线（呼和浩特-银川）.gpx', './railway/京包客运专线（北京北-呼和浩特）.gpx', './railway/京包线（北京丰台-宣化）.gpx', './railway/京包线（黄土店-康庄）.gpx', './railway/京包青龙桥上行线.gpx', './railway/京原线（石景山南-燕山）.gpx', './railway/京哈线（北京-哈尔滨）.gpx', './railway/京哈高速线（北京朝阳-姚家窝堡所）.gpx', './railway/京哈高速线（沈阳北-哈尔滨）.gpx', './railway/京唐城际线（燕郊-北刘各庄所）.gpx', './railway/京广线（武昌-武昌南）.gpx', './railway/京广线（汉西-武昌）.gpx', './railway/京广高速线（北京西-石家庄）.gpx', './railway/京广高速线（横店东-深圳北）.gpx', './railway/京承线（怀柔-顺义）.gpx', './railway/京沪线济南外绕段.gpx', './railway/京沪线（北京-上海）.gpx', './railway/京沪高速线（北京南-上海虹桥）.gpx', './railway/京津城际线（北京南-天津）.gpx', './railway/京通-承隆线（昌平-隆化-承德）.gpx', './railway/京雄城际线（北京西-雄安）.gpx', './railway/伊加线（伊图里河-加格达奇）.gpx', './railway/兰新客运专线（兰州西-海东西）.gpx', './railway/兰青线（兰州-西宁）.gpx', './railway/北京直径线（北京-北京西）.gpx', './railway/南广线（佛山西-广州南）.gpx', './railway/南昌西环线.gpx', './railway/合杭高速线（妙西镇所-桐庐东）.gpx', './railway/合杭高速线（胡庄所-湖州）.gpx', './railway/合福高速线（上饶-福州）.gpx', './railway/合福高速线（合肥南-黄山北）.gpx', './railway/向东联络线（向塘-梁家渡）.gpx', './railway/哈牡客运专线（哈尔滨-牡丹江）.gpx', './railway/哈环线（东门-哈尔滨东）.gpx', './railway/哈长联络线.gpx', './railway/太中线（太原南-定边）.gpx', './railway/太仓联络线（太仓-陆渡所）.gpx', './railway/宁启线（林场-海安）.gpx', './railway/宁杭高速线（湖州-杭州东）.gpx', './railway/宁蓉线（仙林-汉口）.gpx', './railway/宁蓉线（新墩-重庆北）.gpx', './railway/定银线.gpx', './railway/宣绩高速线（宣城-绩溪北）.gpx', './railway/富西线（富裕-漠河）.gpx', './railway/川青线（黄龙九寨-三星堆）.gpx', './railway/巢湖东南联络线.gpx', './railway/平齐线（四平-齐齐哈尔）.gpx', './railway/广州东环城际线（花都-白云机场北）.gpx', './railway/广惠城际线（番禺-西平西）.gpx', './railway/广深城际线（广州东-深圳）.gpx', './railway/广深港高速线（福田-香港西九龙）.gpx', './railway/广清城际线（广州北-清城）.gpx', './railway/广肇城际线（番禺-佛山西）.gpx', './railway/康山联络线.gpx', './railway/康延线.gpx', './railway/延庆线（八达岭西所-延庆）.gpx', './railway/张唐-京承线（唐山-承德）.gpx', './railway/徐兰高速线（天水南-兰州西）.gpx', './railway/徐兰高速线（徐州东所-郑州东）.gpx', './railway/徐盐高速线（徐州东-盐城）.gpx', './railway/德州东联络线.gpx', './railway/怀范联络线（怀柔-雁栖湖）.gpx', './railway/成渝高速线（资阳北-沙坪坝）.gpx', './railway/成贵客运专线（白云北-尖坡所）.gpx', './railway/成贵贵阳北联络线（尖坡所-贵阳北）.gpx', './railway/成贵高速线（成都东-双流机场）.gpx', './railway/拉日线（拉萨-日喀则）.gpx', './railway/敦白联络线.gpx', './railway/新成昆铁路.gpx', './railway/新成灌线（犀浦-都江堰）.gpx', './railway/新通客运专线+姚田联络线.gpx', './railway/新长线（盐城-海安）.gpx', './railway/昆明南联络线.gpx', './railway/昌福线（三江镇-福州）.gpx', './railway/李莘联络线（李家营-莘庄）.gpx', './railway/杭昌高速线（桐庐-黄山北）.gpx', './railway/杭深线（杭州南-深圳北）.gpx', './railway/杭温高速线（桐庐东-义乌）.gpx', './railway/杭温高速线（横店-温州北）.gpx', './railway/桐庐联络线.gpx', './railway/榆红线（榆树屯-红旗营）.gpx', './railway/武九线（九里垄-九江西）.gpx', './railway/武九线（何刘-九里垄）.gpx', './railway/武昌南环线.gpx', './railway/永嘉联络线.gpx', './railway/汉西联络线.gpx', './railway/池黄高速线（池州-黄山北）.gpx', './railway/沈佳高速线（敦化南-长白山）.gpx', './railway/沈大线（大连北-大连）.gpx', './railway/沈大高速线（沈阳北-大连北）.gpx', './railway/沪宁城际线（上海-南京）.gpx', './railway/沪宁沿江高速线（武进-太仓）.gpx', './railway/沪昆线（上海南-贵阳）.gpx', './railway/沪昆线（封浜-李家营）.gpx', './railway/沪昆高速线（上海虹桥-新余北）.gpx', './railway/沪昆高速线（贵阳北-昆明南）.gpx', './railway/沪昆高速线（长沙南-湘潭北）.gpx', './railway/沪苏湖高速线（上海虹桥-湖州）.gpx', './railway/沪苏通线（南通西-黄渡-上海虹桥）.gpx', './railway/津兴城际（盛芳-固安东）.gpx', './railway/津秦客运专线（天津西-秦皇岛）.gpx', './railway/津秦高速线（秦皇岛-龙家营）.gpx', './railway/津蓟线.gpx', './railway/津霸线（天津西-霸州西）.gpx', './railway/济青高速线（济南东-青岛北）.gpx', './railway/渝贵线（贵阳-贵阳北）.gpx', './railway/滇藏线（丽江-香格里拉）.gpx', './railway/滨北线（哈尔滨东-呼兰）.gpx', './railway/滨洲线（哈尔滨-海拉尔）.gpx', './railway/滨绥线（新香坊-牡丹江）.gpx', './railway/滨绥线（牡丹江-绥芬河）.gpx', './railway/牙林线（牙克石-伊图里河）.gpx', './railway/甬广高速线（福州南-厦门北）.gpx', './railway/盐通高速线（盐城-南通西）.gpx', './railway/石太客运专线（石家庄北-太原南）.gpx', './railway/石家庄西北环线（柳辛庄-石家庄北）.gpx', './railway/石济客运专线（陵县所-济南东）.gpx', './railway/秦双联络线（秦祺村所-双龙南）.gpx', './railway/笕杭线.gpx', './railway/笕桥线.gpx', './railway/胶济客运专线（济南-青岛北）.gpx', './railway/花广联络线（广州白云-广州北）.gpx', './railway/萧甬线（杭州南-绍兴）.gpx', './railway/虹安联络线（上海虹桥-安亭北所）.gpx', './railway/衢九线.gpx', './railway/西成高速线（广汉北-成都东）.gpx', './railway/西长-京广线（北京西-柳辛庄）.gpx', './railway/贵阳环线（白云北-双龙南）.gpx', './railway/辛泰线（南博山-泰山）.gpx', './railway/连镇高速线（连云港-丹徒）.gpx', './railway/通燕联络线（高辛庄所-北刘各庄所）.gpx', './railway/郑开城际线（郑州东-开封）.gpx', './railway/镇江联络线.gpx', './railway/长株潭城际线（谷山-湘潭）.gpx', './railway/长珲城际线（杨家粉坊所-敦化）.gpx', './railway/陇海线（徐州-兰州）.gpx', './railway/霸徐线（白洋淀-霸州西）.gpx', './railway/青三联络线.gpx', './railway/青盐线（连云港-董集）.gpx', './railway/青藏线（西宁-拉萨）.gpx', './railway/鹰厦线（前场-厦门）.gpx', './railway/齐北线（齐齐哈尔-富裕）.gpx']
    },
    // runs: { color: "blue", files: [
    //   "runs/morning_run_1.gpx",
    //   "runs/morning_run_2.gpx"
    // ]}
  };

  const icons = {
    flights: L.icon({
      iconUrl: "assets/airport.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    }),
    railway: L.icon({
      iconUrl: "assets/station.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    })
  };

  const overlays = {};  // 每个文件夹一组图层
  let globalBounds = null;

  for (const [folder, cfg] of Object.entries(groups)) {
    const layerGroup = L.layerGroup();
    overlays[folder] = layerGroup;  // 让 layer control 可以控制开关

    cfg.files.forEach(file => {
      new L.GPX(file, {
        async: true,
        polyline_options: {
          color: cfg.color,
          weight: 4,
          opacity: 0.85
        },
        markers: {
          startIcon: null,
          endIcon: null,
          // shadowUrl: ''
        }
      })
      .on("loaded", e => {
        const g = e.target;
        const filename = file.split("/").pop(); // 取文件名部分
        const match = filename.match(/_(\w+)_([0-9]{8})\.gpx$/);
        let displayName;

        if (match) {
          displayName = `${match[1]}-${match[2]}`;
        } else {
          displayName = filename.replace(".gpx", "");
        }

        g.bindPopup(`<b>${displayName}</b>`);

        // 更新全局视图范围
        const b = g.getBounds();
        if (globalBounds) globalBounds.extend(b);
        else globalBounds = b;

        map.fitBounds(globalBounds, { padding: [20, 20] });
      })
      .addTo(layerGroup);
    });
  }

  // === 加载独立点（从外部 JSON）===
  fetch("./flights/airport.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue; // 没有对应组则跳过

        points.forEach(p => {
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${p.name}</b>`)
            .addTo(group);
        });
      }
    })
  .catch(err => console.error("加载 airport.json 出错:", err));

  fetch("./railway/station.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue; // 没有对应组则跳过

        points.forEach(p => {
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${p.name}</b>`)
            .addTo(group);
        });
      }
    })
  .catch(err => console.error("加载 station.json 出错:", err));

  overlays["flights"].setZIndex(1000);
  overlays["railway"].setZIndex(500);

  L.control.layers(null, overlays, { collapsed: false }).addTo(map);

//   tracks.forEach(({ file, color }) => {
//     const gpx = new L.GPX(file, {
//       async: true,
//       polyline_options: { color, weight: 4, opacity: 0.8 },
//       markers: {
//         startIcon: null,
//         endIcon: null,
//         // wptIcons: null,
//       },
//     })
//       .on("loaded", (e) => {
//         const g = e.target;
//         const name = g.get_name() || file;
//         g.bindPopup(`<b>${name}</b>`);
// 
//         bounds.push(g.getBounds());
//         if (bounds.length === tracks.length) {
//           const all = bounds.reduce((b, cur) => b.extend(cur), bounds[0]);
//           map.fitBounds(all);
//         }
// 
//         g.eachLayer((layer) => {
//           if (layer instanceof L.Marker) {
//             map.removeLayer(layer);
//           }
//         });
//       })
//       .addTo(map);
//   });
</script>

</body>
</html>
