<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Where did I go</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script>

  <style>
    body { margin: 0; padding: 0; }
    /* === é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ === */
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background-color: #1e293b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-family: sans-serif;
      z-index: 1000;
    }

    #navbar .nav-left .logo {
      font-weight: bold;
      font-size: 18px;
    }

    #navbar .nav-center a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      font-size: 15px;
    }

    #navbar .nav-center a:hover {
      text-decoration: underline;
    }

    #navbar .nav-right select {
      background-color: #1e293b;
      color: white;
      border: 1px solid #475569;
      border-radius: 4px;
      padding: 3px 6px;
    }

    /* === åœ°å›¾å®¹å™¨åç§»ï¼ˆé¿å…è¢«å¯¼èˆªæ é®æŒ¡ï¼‰ === */
    #map {
      height: calc(100vh - 50px);
      width: 100%;
      margin-top: 50px; /* ç•™å‡ºå¯¼èˆªæ é«˜åº¦ */
    }
  </style>
</head>
<body>

<nav id="navbar">
  <div class="nav-left">
    <span class="logo" data-i18n="title">ğŸŒ Where did I go</span>
  </div>

  <div class="nav-center">
    <a href="index.html" data-i18n="nav.home">Home</a>
    <a href="flights.html" data-i18n="nav.flights">Flights</a>
    <a href="railway.html" data-i18n="nav.railway">Railways</a>
    <a href="points.html" data-i18n="nav.points">Landmarks</a>
  </div>

  <div class="nav-right">
    <select id="langSelect">
      <option value="zh">ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
  </div>
</nav>

<div id="map"></div>

<script>

  // 1ï¸âƒ£ è·å– URL å‚æ•°
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // 2ï¸âƒ£ åˆå§‹åŒ–è¯­è¨€
  let currentLang = getQueryParam("lang") || localStorage.getItem("lang") || "zh";
  localStorage.setItem("lang", currentLang);

  // è®¾ç½®ä¸‹æ‹‰æ¡†é€‰ä¸­
  document.getElementById("langSelect").value = currentLang;

  // 3ï¸âƒ£ åŠ è½½è¯­è¨€ JSON å¹¶æ›´æ–°æ–‡æœ¬
  async function loadLanguage(lang) {
    try {
      const resp = await fetch("lang.json");
      const data = await resp.json();
      const dict = data[lang] || data["zh"];

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const keys = el.dataset.i18n.split(".");
        let value = dict;
        for (const key of keys) value = value ? value[key] : null;
        if (value) el.textContent = value;
      });
    } catch (err) {
      console.error("è¯­è¨€æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
    }
  }

  loadLanguage(currentLang);

  // 4ï¸âƒ£ åˆ‡æ¢è¯­è¨€æ—¶æ›´æ–° URLï¼ˆåˆ·æ–°é¡µé¢ï¼‰
  document.getElementById("langSelect").addEventListener("change", e => {
    const newLang = e.target.value;
    localStorage.setItem("lang", newLang);

    // åˆ·æ–°é¡µé¢å¹¶å¸¦ä¸Š ?lang å‚æ•°
    const newUrl = `${window.location.pathname}?lang=${newLang}`;
    window.location.href = newUrl;
  });

  const map = L.map("map").setView([31, 121], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors',
  }).addTo(map);

  const groups = {
    flights: { color: "blue", files: ['./flights/gpx/Variflight_8L9518_20250908.gpx', './flights/gpx/Variflight_9C6363_20250301.gpx', './flights/gpx/Variflight_9C6998_20250304.gpx', './flights/gpx/Variflight_9C8909_20241108.gpx', './flights/gpx/Variflight_9H8403_20250909.gpx', './flights/gpx/Variflight_CA1550_20240611.gpx', './flights/gpx/Variflight_CA1829_20240611.gpx', './flights/gpx/Variflight_CA952_20250216.gpx', './flights/gpx/Variflight_CZ2308_20250528.gpx', './flights/gpx/Variflight_CZ3533_20250426.gpx', './flights/gpx/Variflight_CZ6252_20250606.gpx', './flights/gpx/Variflight_CZ6257_20250608.gpx', './flights/gpx/Variflight_CZ6521_20250219.gpx', './flights/gpx/Variflight_CZ6525_20241007.gpx', './flights/gpx/Variflight_CZ6526_20241001.gpx', './flights/gpx/Variflight_CZ6526_20250219.gpx', './flights/gpx/Variflight_CZ6536_20250214.gpx', './flights/gpx/Variflight_CZ6697_20250420.gpx', './flights/gpx/Variflight_CZ6909_20250603.gpx', './flights/gpx/Variflight_CZ7054_20250815.gpx', './flights/gpx/Variflight_CZ8264_20250418.gpx', './flights/gpx/Variflight_CZ8839_20241021.gpx', './flights/gpx/Variflight_CZ8879_20241104.gpx', './flights/gpx/Variflight_CZ8879_20241202.gpx', './flights/gpx/Variflight_CZ8880_20241129.gpx', './flights/gpx/Variflight_CZ8886_20250411.gpx', './flights/gpx/Variflight_CZ8886_20250515.gpx', './flights/gpx/Variflight_CZ8888_20241220.gpx', './flights/gpx/Variflight_CZ8889_20241222.gpx', './flights/gpx/Variflight_CZ888R_20241102.gpx', './flights/gpx/Variflight_CZ8899_20250604.gpx', './flights/gpx/Variflight_FM823_20250529.gpx', './flights/gpx/Variflight_FM9224_20251018.gpx', './flights/gpx/Variflight_G54818_20250820.gpx', './flights/gpx/Variflight_GS6697_20250915.gpx', './flights/gpx/Variflight_GS7974_20250912.gpx', './flights/gpx/Variflight_GS7983_20250910.gpx', './flights/gpx/Variflight_GX8960_20251026.gpx', './flights/gpx/Variflight_HO2348_20240719.gpx', './flights/gpx/Variflight_HU7145_20251012.gpx', './flights/gpx/Variflight_HU7246_20251011.gpx', './flights/gpx/Variflight_HU7705_20240606.gpx', './flights/gpx/Variflight_JD5314_20251028.gpx', './flights/gpx/Variflight_JD5550_20240712.gpx', './flights/gpx/Variflight_KN2905_20250216.gpx', './flights/gpx/Variflight_MU2039_20250807.gpx', './flights/gpx/Variflight_MU2074_20250530.gpx', './flights/gpx/Variflight_MU2191_20250502.gpx', './flights/gpx/Variflight_MU2192_20250502.gpx', './flights/gpx/Variflight_MU2216_20250316.gpx', './flights/gpx/Variflight_MU2233_20250315.gpx', './flights/gpx/Variflight_MU2239_20250316.gpx', './flights/gpx/Variflight_MU2350_20250909.gpx', './flights/gpx/Variflight_MU5052_20250808.gpx', './flights/gpx/Variflight_MU5152_20250414.gpx', './flights/gpx/Variflight_MU5296_20250105.gpx', './flights/gpx/Variflight_MU5308_20250916.gpx', './flights/gpx/Variflight_MU5319_20250426.gpx', './flights/gpx/Variflight_MU5417_20250102.gpx', './flights/gpx/Variflight_MU5428_20250529.gpx', './flights/gpx/Variflight_MU5523_20250806.gpx', './flights/gpx/Variflight_MU6128_20250713.gpx', './flights/gpx/Variflight_MU6135_20250502.gpx', './flights/gpx/Variflight_MU6337_20250808.gpx', './flights/gpx/Variflight_MU6357_20250710.gpx', './flights/gpx/Variflight_MU6513_20250908.gpx', './flights/gpx/Variflight_MU6514_20250909.gpx', './flights/gpx/Variflight_MU6582_20250713.gpx', './flights/gpx/Variflight_MU6873_20250824.gpx', './flights/gpx/Variflight_MU6939_20250917.gpx', './flights/gpx/Variflight_MU720_20250314.gpx', './flights/gpx/Variflight_MU8342_20250518.gpx', './flights/gpx/Variflight_MU9205_20241227.gpx', './flights/gpx/Variflight_MU9851_20250603.gpx', './flights/gpx/Variflight_PN6260_20250904.gpx', './flights/gpx/Variflight_PN6271_20250905.gpx']
    },
    railway: { color: "green", files: ['./railway/gpx_cr/ä¸Šæµ·å—è”ç»œçº¿ï¼ˆæ²ªæ˜¥ä¸€äºŒçº¿ï¼‰.gpx', './railway/gpx_cr/ä¸Šæµ·å—è”ç»œçº¿ï¼ˆæ²ªæ˜¥ä¸‰å››çº¿ï¼‰.gpx', './railway/gpx_cr/ä¸Šé¥¶ä¸œå—è”ç»œçº¿.gpx', './railway/gpx_cr/ä¸œæ–°è”ç»œçº¿ï¼ˆä¸œé—¨-æ–°é¦™åŠï¼‰.gpx', './railway/gpx_cr/ä¸œæ˜Ÿçº¿ï¼ˆåŒ—äº¬ä¸œ-åŒ—äº¬æœé˜³ï¼‰.gpx', './railway/gpx_cr/äº¬ä¹çº¿ï¼ˆå—æ˜Œ-å‘å¡˜-ä¸‰æ±Ÿé•‡ï¼‰.gpx', './railway/gpx_cr/äº¬ä¹çº¿ï¼ˆé»„åœŸå¡çº¿è·¯æ‰€-ä¹åŒ–ï¼‰.gpx', './railway/gpx_cr/äº¬åŒ…-åŒ…å…°çº¿ï¼ˆå‘¼å’Œæµ©ç‰¹-é“¶å·ï¼‰.gpx', './railway/gpx_cr/äº¬åŒ…å®¢è¿ä¸“çº¿ï¼ˆåŒ—äº¬åŒ—-å‘¼å’Œæµ©ç‰¹ï¼‰.gpx', './railway/gpx_cr/äº¬åŒ…çº¿ï¼ˆåŒ—äº¬ä¸°å°-å®£åŒ–ï¼‰.gpx', './railway/gpx_cr/äº¬åŒ…çº¿ï¼ˆé»„åœŸåº—-åº·åº„ï¼‰.gpx', './railway/gpx_cr/äº¬åŒ…é’é¾™æ¡¥ä¸Šè¡Œçº¿.gpx', './railway/gpx_cr/äº¬åŸçº¿ï¼ˆçŸ³æ™¯å±±å—-ç‡•å±±ï¼‰.gpx', './railway/gpx_cr/äº¬å“ˆçº¿ï¼ˆåŒ—äº¬-å“ˆå°”æ»¨ï¼‰.gpx', './railway/gpx_cr/äº¬å“ˆé«˜é€Ÿçº¿ï¼ˆåŒ—äº¬æœé˜³-å§šå®¶çªå ¡æ‰€ï¼‰.gpx', './railway/gpx_cr/äº¬å“ˆé«˜é€Ÿçº¿ï¼ˆæ²ˆé˜³åŒ—-å“ˆå°”æ»¨ï¼‰.gpx', './railway/gpx_cr/äº¬å”åŸé™…çº¿ï¼ˆç‡•éƒŠ-åŒ—åˆ˜å„åº„æ‰€ï¼‰.gpx', './railway/gpx_cr/äº¬å¹¿çº¿ï¼ˆæ­¦æ˜Œ-æ­¦æ˜Œå—ï¼‰.gpx', './railway/gpx_cr/äº¬å¹¿çº¿ï¼ˆæ±‰è¥¿-æ­¦æ˜Œï¼‰.gpx', './railway/gpx_cr/äº¬å¹¿çº¿ï¼ˆé•¿è¾›åº—-æŸ³è¾›åº„ï¼‰.gpx', './railway/gpx_cr/äº¬å¹¿é«˜é€Ÿçº¿ï¼ˆåŒ—äº¬è¥¿-çŸ³å®¶åº„ï¼‰.gpx', './railway/gpx_cr/äº¬å¹¿é«˜é€Ÿçº¿ï¼ˆæ¨ªåº—ä¸œ-æ·±åœ³åŒ—ï¼‰.gpx', './railway/gpx_cr/äº¬æ‰¿çº¿ï¼ˆæ€€æŸ”-é¡ºä¹‰ï¼‰.gpx', './railway/gpx_cr/äº¬æ‰¿çº¿ï¼ˆèµµå®¶åº—æ‰€-æ‰¿å¾·ï¼‰.gpx', './railway/gpx_cr/äº¬æ²ªçº¿æµå—å¤–ç»•æ®µ.gpx', './railway/gpx_cr/äº¬æ²ªçº¿ï¼ˆåŒ—äº¬-ä¸Šæµ·ï¼‰.gpx', './railway/gpx_cr/äº¬æ²ªé«˜é€Ÿçº¿ï¼ˆåŒ—äº¬å—-ä¸Šæµ·è™¹æ¡¥ï¼‰.gpx', './railway/gpx_cr/äº¬æ´¥åŸé™…çº¿ï¼ˆåŒ—äº¬å—-å¤©æ´¥ï¼‰.gpx', './railway/gpx_cr/äº¬é€šçº¿ï¼ˆæ˜Œå¹³-éš†åŒ–ï¼‰.gpx', './railway/gpx_cr/äº¬é›„åŸé™…çº¿ï¼ˆåŒ—äº¬è¥¿-é›„å®‰ï¼‰.gpx', './railway/gpx_cr/ä¼ŠåŠ çº¿ï¼ˆä¼Šå›¾é‡Œæ²³-åŠ æ ¼è¾¾å¥‡ï¼‰.gpx', './railway/gpx_cr/å…°æ–°å®¢è¿ä¸“çº¿ï¼ˆå…°å·è¥¿-æµ·ä¸œè¥¿ï¼‰.gpx', './railway/gpx_cr/å…°é’çº¿ï¼ˆå…°å·-è¥¿å®ï¼‰.gpx', './railway/gpx_cr/åŒ—äº¬ç›´å¾„çº¿ï¼ˆåŒ—äº¬-åŒ—äº¬è¥¿ï¼‰.gpx', './railway/gpx_cr/å—å‡­é«˜é€Ÿçº¿ï¼ˆå—å®-å´‡å·¦å—ï¼‰.gpx', './railway/gpx_cr/å—å¹¿çº¿ï¼ˆä½›å±±è¥¿-å¹¿å·å—ï¼‰.gpx', './railway/gpx_cr/å—æ˜Œè¥¿ç¯çº¿.gpx', './railway/gpx_cr/å—ç é«˜é€Ÿçº¿ï¼ˆå—å®ä¸œ-ç‰æ—åŒ—ï¼‰.gpx', './railway/gpx_cr/åˆæ­é«˜é€Ÿçº¿ï¼ˆå¦™è¥¿é•‡æ‰€-æ¡åºä¸œï¼‰.gpx', './railway/gpx_cr/åˆæ­é«˜é€Ÿçº¿ï¼ˆèƒ¡åº„æ‰€-æ¹–å·ï¼‰.gpx', './railway/gpx_cr/åˆç¦é«˜é€Ÿçº¿ï¼ˆä¸Šé¥¶-ç¦å·ï¼‰.gpx', './railway/gpx_cr/åˆç¦é«˜é€Ÿçº¿ï¼ˆåˆè‚¥å—-é»„å±±åŒ—ï¼‰.gpx', './railway/gpx_cr/å‘ä¸œè”ç»œçº¿ï¼ˆå‘å¡˜-æ¢å®¶æ¸¡ï¼‰.gpx', './railway/gpx_cr/å“ˆç‰¡å®¢è¿ä¸“çº¿ï¼ˆå“ˆå°”æ»¨-ç‰¡ä¸¹æ±Ÿï¼‰.gpx', './railway/gpx_cr/å“ˆç¯çº¿ï¼ˆä¸œé—¨-å“ˆå°”æ»¨ä¸œï¼‰.gpx', './railway/gpx_cr/å“ˆé•¿è”ç»œçº¿.gpx', './railway/gpx_cr/å¤ªä¸­çº¿ï¼ˆå¤ªåŸå—-å®šè¾¹ï¼‰.gpx', './railway/gpx_cr/å¤ªä»“è”ç»œçº¿ï¼ˆå¤ªä»“-é™†æ¸¡æ‰€ï¼‰.gpx', './railway/gpx_cr/å§šç”°è”ç»œçº¿.gpx', './railway/gpx_cr/å®å¯çº¿ï¼ˆæ—åœº-æµ·å®‰ï¼‰.gpx', './railway/gpx_cr/å®æ­é«˜é€Ÿçº¿ï¼ˆæ¹–å·-æ­å·ä¸œï¼‰.gpx', './railway/gpx_cr/å®è“‰çº¿ï¼ˆä»™æ—-æ±‰å£ï¼‰.gpx', './railway/gpx_cr/å®è“‰çº¿ï¼ˆæ–°å¢©-é‡åº†åŒ—ï¼‰.gpx', './railway/gpx_cr/å®šé“¶çº¿ï¼ˆå®šè¾¹-é“¶å·ï¼‰.gpx', './railway/gpx_cr/å®£ç»©é«˜é€Ÿçº¿ï¼ˆå®£åŸ-ç»©æºªåŒ—ï¼‰.gpx', './railway/gpx_cr/å¯Œè¥¿çº¿ï¼ˆå¯Œè£•-æ¼ æ²³ï¼‰.gpx', './railway/gpx_cr/å³¨å¹¿çº¿ï¼ˆå³¨çœ‰-å¹¿é€šåŒ—ï¼‰.gpx', './railway/gpx_cr/å·é’çº¿ï¼ˆé»„é¾™ä¹å¯¨-ä¸‰æ˜Ÿå †ï¼‰.gpx', './railway/gpx_cr/å·¢æ¹–ä¸œå—è”ç»œçº¿.gpx', './railway/gpx_cr/å¹³é½çº¿ï¼ˆå››å¹³-é½é½å“ˆå°”ï¼‰.gpx', './railway/gpx_cr/å¹¿å·ä¸œç¯åŸé™…çº¿ï¼ˆèŠ±éƒ½-ç™½äº‘æœºåœºåŒ—ï¼‰.gpx', './railway/gpx_cr/å¹¿æƒ åŸé™…çº¿ï¼ˆç•ªç¦º-è¥¿å¹³è¥¿ï¼‰.gpx', './railway/gpx_cr/å¹¿æ·±åŸé™…çº¿ï¼ˆå¹¿å·ä¸œ-æ·±åœ³ï¼‰.gpx', './railway/gpx_cr/å¹¿æ·±æ¸¯é«˜é€Ÿçº¿ï¼ˆç¦ç”°-é¦™æ¸¯è¥¿ä¹é¾™ï¼‰.gpx', './railway/gpx_cr/å¹¿æ¸…åŸé™…çº¿ï¼ˆå¹¿å·åŒ—-æ¸…åŸï¼‰.gpx', './railway/gpx_cr/å¹¿è‚‡åŸé™…çº¿ï¼ˆç•ªç¦º-ä½›å±±è¥¿ï¼‰.gpx', './railway/gpx_cr/åº·å±±è”ç»œçº¿.gpx', './railway/gpx_cr/åº·å»¶çº¿.gpx', './railway/gpx_cr/å»¶åº†çº¿ï¼ˆå…«è¾¾å²­è¥¿æ‰€-å»¶åº†ï¼‰.gpx', './railway/gpx_cr/å¼ å”çº¿ï¼ˆæå®¶è¥-å”å±±ï¼‰.gpx', './railway/gpx_cr/å¾å…°é«˜é€Ÿçº¿ï¼ˆå¤©æ°´å—-å…°å·è¥¿ï¼‰.gpx', './railway/gpx_cr/å¾å…°é«˜é€Ÿçº¿ï¼ˆå¾å·ä¸œæ‰€-éƒ‘å·ä¸œï¼‰.gpx', './railway/gpx_cr/å¾ç›é«˜é€Ÿçº¿ï¼ˆå¾å·ä¸œ-ç›åŸï¼‰.gpx', './railway/gpx_cr/å¾·å·ä¸œè”ç»œçº¿.gpx', './railway/gpx_cr/æ€€èŒƒè”ç»œçº¿ï¼ˆæ€€æŸ”-é›æ –æ¹–ï¼‰.gpx', './railway/gpx_cr/æˆæ˜†çº¿ï¼ˆæˆéƒ½å—-ç‡•å²—ï¼‰.gpx', './railway/gpx_cr/æˆæ¸é«˜é€Ÿçº¿ï¼ˆèµ„é˜³åŒ—-æ²™åªåï¼‰.gpx', './railway/gpx_cr/æˆè´µå®¢è¿ä¸“çº¿ï¼ˆæˆéƒ½ä¸œ-åŒæµæœºåœºï¼‰.gpx', './railway/gpx_cr/æˆè´µå®¢è¿ä¸“çº¿ï¼ˆç™½äº‘åŒ—-å°–å¡æ‰€ï¼‰.gpx', './railway/gpx_cr/æˆè´µè´µé˜³åŒ—è”ç»œçº¿ï¼ˆå°–å¡æ‰€-è´µé˜³åŒ—ï¼‰.gpx', './railway/gpx_cr/æ‰¿éš†çº¿ï¼ˆéš†åŒ–-æ‰¿å¾·ï¼‰.gpx', './railway/gpx_cr/æ‹‰æ—¥çº¿ï¼ˆæ‹‰è¨-æ—¥å–€åˆ™ï¼‰.gpx', './railway/gpx_cr/æ•¦ç™½è”ç»œçº¿.gpx', './railway/gpx_cr/æ–°æˆçŒçº¿ï¼ˆçŠ€æµ¦-éƒ½æ±Ÿå °ï¼‰.gpx', './railway/gpx_cr/æ–°é€šå®¢è¿ä¸“çº¿ï¼ˆç”°å®¶çªé“ºæ‰€-é€šè¾½ï¼‰.gpx', './railway/gpx_cr/æ–°é•¿çº¿ï¼ˆç›åŸ-æµ·å®‰ï¼‰.gpx', './railway/gpx_cr/æ˜†æ˜å—è”ç»œçº¿.gpx', './railway/gpx_cr/æ˜Œç¦çº¿ï¼ˆä¸‰æ±Ÿé•‡-ç¦å·ï¼‰.gpx', './railway/gpx_cr/æå®¶è¥è”ç»œçº¿ï¼ˆæå®¶è¥-èµµå®¶åº—æ‰€ï¼‰.gpx', './railway/gpx_cr/æè˜è”ç»œçº¿ï¼ˆæå®¶æ¹¾-è˜åº„ï¼‰.gpx', './railway/gpx_cr/æ­æ˜Œé«˜é€Ÿçº¿ï¼ˆæ¡åº-é»„å±±åŒ—ï¼‰.gpx', './railway/gpx_cr/æ­æ·±çº¿ï¼ˆæ­å·å—-æ·±åœ³åŒ—ï¼‰.gpx', './railway/gpx_cr/æ­æ¸©é«˜é€Ÿçº¿ï¼ˆæ¡åºä¸œ-ä¹‰ä¹Œï¼‰.gpx', './railway/gpx_cr/æ­æ¸©é«˜é€Ÿçº¿ï¼ˆæ¨ªåº—-æ¸©å·åŒ—ï¼‰.gpx', './railway/gpx_cr/æ¡åºè”ç»œçº¿.gpx', './railway/gpx_cr/æ¦†çº¢çº¿ï¼ˆæ¦†æ ‘å±¯-çº¢æ——è¥ï¼‰.gpx', './railway/gpx_cr/æ­¦ä¹çº¿ï¼ˆä¹é‡Œå„-ä¹æ±Ÿè¥¿ï¼‰.gpx', './railway/gpx_cr/æ­¦ä¹çº¿ï¼ˆä½•åˆ˜-ä¹é‡Œå„ï¼‰.gpx', './railway/gpx_cr/æ­¦æ˜Œå—ç¯çº¿.gpx', './railway/gpx_cr/æ°¸å˜‰è”ç»œçº¿.gpx', './railway/gpx_cr/æ±‰è¥¿è”ç»œçº¿.gpx', './railway/gpx_cr/æ± é»„é«˜é€Ÿçº¿ï¼ˆæ± å·-é»„å±±åŒ—ï¼‰.gpx', './railway/gpx_cr/æ²ˆä½³é«˜é€Ÿçº¿ï¼ˆæ•¦åŒ–å—-é•¿ç™½å±±ï¼‰.gpx', './railway/gpx_cr/æ²ˆå¤§çº¿ï¼ˆå¤§è¿åŒ—-å¤§è¿ï¼‰.gpx', './railway/gpx_cr/æ²ˆå¤§é«˜é€Ÿçº¿ï¼ˆæ²ˆé˜³åŒ—-å¤§è¿åŒ—ï¼‰.gpx', './railway/gpx_cr/æ²ªå®åŸé™…çº¿ï¼ˆä¸Šæµ·-å—äº¬ï¼‰.gpx', './railway/gpx_cr/æ²ªå®æ²¿æ±Ÿé«˜é€Ÿçº¿ï¼ˆæ­¦è¿›-å¤ªä»“ï¼‰.gpx', './railway/gpx_cr/æ²ªæ˜†çº¿ï¼ˆå°æµœ-é¾™é‡Œï¼‰.gpx', './railway/gpx_cr/æ²ªæ˜†é«˜é€Ÿçº¿ï¼ˆä¸Šæµ·è™¹æ¡¥-æ–°ä½™åŒ—ï¼‰.gpx', './railway/gpx_cr/æ²ªæ˜†é«˜é€Ÿçº¿ï¼ˆè´µé˜³åŒ—-æ˜†æ˜å—ï¼‰.gpx', './railway/gpx_cr/æ²ªæ˜†é«˜é€Ÿçº¿ï¼ˆé•¿æ²™å—-æ¹˜æ½­åŒ—ï¼‰.gpx', './railway/gpx_cr/æ²ªè‹æ¹–é«˜é€Ÿçº¿ï¼ˆä¸Šæµ·è™¹æ¡¥-æ¹–å·ï¼‰.gpx', './railway/gpx_cr/æ²ªè‹é€šçº¿ï¼ˆå—é€šè¥¿-é»„æ¸¡-ä¸Šæµ·è™¹æ¡¥ï¼‰.gpx', './railway/gpx_cr/æ´¥å…´åŸé™…ï¼ˆç››èŠ³-å›ºå®‰ä¸œï¼‰.gpx', './railway/gpx_cr/æ´¥ç§¦é«˜é€Ÿçº¿ï¼ˆå¤©æ´¥è¥¿-ç§¦çš‡å²›ï¼‰.gpx', './railway/gpx_cr/æ´¥ç§¦é«˜é€Ÿçº¿ï¼ˆç§¦çš‡å²›-é¾™å®¶è¥ï¼‰.gpx', './railway/gpx_cr/æ´¥è“Ÿçº¿.gpx', './railway/gpx_cr/æ´¥éœ¸çº¿ï¼ˆå¤©æ´¥è¥¿-éœ¸å·è¥¿ï¼‰.gpx', './railway/gpx_cr/æµé’é«˜é€Ÿçº¿ï¼ˆæµå—ä¸œ-é’å²›åŒ—ï¼‰.gpx', './railway/gpx_cr/æ¸è´µçº¿ï¼ˆè´µé˜³-è´µé˜³åŒ—ï¼‰.gpx', './railway/gpx_cr/æ¹˜æ¡‚çº¿ï¼ˆæŸ³å·-é»å¡˜ï¼‰.gpx', './railway/gpx_cr/æ»‡è—çº¿ï¼ˆä¸½æ±Ÿ-é¦™æ ¼é‡Œæ‹‰ï¼‰.gpx', './railway/gpx_cr/æ»¨åŒ—çº¿ï¼ˆå“ˆå°”æ»¨ä¸œ-å‘¼å…°ï¼‰.gpx', './railway/gpx_cr/æ»¨æ´²çº¿ï¼ˆå“ˆå°”æ»¨-æµ·æ‹‰å°”ï¼‰.gpx', './railway/gpx_cr/æ»¨ç»¥çº¿ï¼ˆæ–°é¦™åŠ-ç‰¡ä¸¹æ±Ÿï¼‰.gpx', './railway/gpx_cr/æ»¨ç»¥çº¿ï¼ˆç‰¡ä¸¹æ±Ÿ-ç»¥èŠ¬æ²³ï¼‰.gpx', './railway/gpx_cr/ç‰™æ—çº¿ï¼ˆç‰™å…‹çŸ³-ä¼Šå›¾é‡Œæ²³ï¼‰.gpx', './railway/gpx_cr/ç”¬å¹¿é«˜é€Ÿçº¿ï¼ˆç¦å·å—-å¦é—¨åŒ—ï¼‰.gpx', './railway/gpx_cr/ç›é€šé«˜é€Ÿçº¿ï¼ˆç›åŸ-å—é€šè¥¿ï¼‰.gpx', './railway/gpx_cr/çŸ³å¤ªå®¢è¿ä¸“çº¿ï¼ˆçŸ³å®¶åº„åŒ—-å¤ªåŸå—ï¼‰.gpx', './railway/gpx_cr/çŸ³å®¶åº„è¥¿åŒ—ç¯çº¿ï¼ˆæŸ³è¾›åº„-çŸ³å®¶åº„åŒ—ï¼‰.gpx', './railway/gpx_cr/çŸ³æµå®¢è¿ä¸“çº¿ï¼ˆé™µå¿æ‰€-æµå—ä¸œï¼‰.gpx', './railway/gpx_cr/ç§¦åŒè”ç»œçº¿ï¼ˆç§¦ç¥ºæ‘æ‰€-åŒé¾™å—ï¼‰.gpx', './railway/gpx_cr/ç¬•æ­çº¿.gpx', './railway/gpx_cr/ç¬•æ¡¥çº¿.gpx', './railway/gpx_cr/èƒ¶æµå®¢è¿ä¸“çº¿ï¼ˆæµå—-é’å²›åŒ—ï¼‰.gpx', './railway/gpx_cr/èŠ±å¹¿è”ç»œçº¿ï¼ˆå¹¿å·ç™½äº‘-å¹¿å·åŒ—ï¼‰.gpx', './railway/gpx_cr/è§ç”¬çº¿ï¼ˆæ­å·å—-ç»å…´ï¼‰.gpx', './railway/gpx_cr/è™¹å®‰è”ç»œçº¿ï¼ˆä¸Šæµ·è™¹æ¡¥-å®‰äº­åŒ—æ‰€ï¼‰.gpx', './railway/gpx_cr/è¡¢ä¹çº¿ï¼ˆè¡¢å·-ä¹æ±Ÿï¼‰.gpx', './railway/gpx_cr/è¥¿æˆé«˜é€Ÿçº¿ï¼ˆå¹¿æ±‰åŒ—-æˆéƒ½ä¸œï¼‰.gpx', './railway/gpx_cr/è¥¿é•¿çº¿ï¼ˆåŒ—äº¬è¥¿-é•¿è¾›åº—ï¼‰.gpx', './railway/gpx_cr/è´µå—é«˜é€Ÿçº¿ï¼ˆæ²³æ± è¥¿-å—å®ä¸œï¼‰.gpx', './railway/gpx_cr/è´µé˜³ç¯çº¿ï¼ˆç™½äº‘åŒ—-åŒé¾™å—ï¼‰.gpx', './railway/gpx_cr/è¾›æ³°çº¿ï¼ˆå—åšå±±-æ³°å±±ï¼‰.gpx', './railway/gpx_cr/è¿é•‡é«˜é€Ÿçº¿ï¼ˆè¿äº‘æ¸¯-ä¸¹å¾’ï¼‰.gpx', './railway/gpx_cr/é€šç‡•è”ç»œçº¿ï¼ˆé«˜è¾›åº„æ‰€-åŒ—åˆ˜å„åº„æ‰€ï¼‰.gpx', './railway/gpx_cr/éƒ‘å¼€åŸé™…çº¿ï¼ˆéƒ‘å·ä¸œ-å¼€å°ï¼‰.gpx', './railway/gpx_cr/é•‡æ±Ÿè”ç»œçº¿.gpx', './railway/gpx_cr/é•¿æ ªæ½­åŸé™…çº¿ï¼ˆè°·å±±-æ¹˜æ½­ï¼‰.gpx', './railway/gpx_cr/é•¿ç²åŸé™…çº¿ï¼ˆæ¨å®¶ç²‰åŠæ‰€-æ•¦åŒ–ï¼‰.gpx', './railway/gpx_cr/é™‡æµ·çº¿ï¼ˆå¾å·-å…°å·ï¼‰.gpx', './railway/gpx_cr/éœ¸å¾çº¿ï¼ˆç™½æ´‹æ·€-éœ¸å·è¥¿ï¼‰.gpx', './railway/gpx_cr/é’ä¸‰è”ç»œçº¿ï¼ˆé’ç™½æ±Ÿä¸œ-ä¸‰æ˜Ÿå †ï¼‰.gpx', './railway/gpx_cr/é’ç›çº¿ï¼ˆè¿äº‘æ¸¯-è‘£é›†ï¼‰.gpx', './railway/gpx_cr/é’è—çº¿ï¼ˆè¥¿å®-æ‹‰è¨ï¼‰.gpx', './railway/gpx_cr/é¹°å¦çº¿ï¼ˆå‰åœº-å¦é—¨ï¼‰.gpx', './railway/gpx_cr/é»æ¹›çº¿ï¼ˆé»å¡˜-ç‰æ—ï¼‰.gpx', './railway/gpx_cr/é»”æ¡‚çº¿ï¼ˆé‡‘åŸæ±Ÿ-æŸ³å·ï¼‰.gpx', './railway/gpx_cr/é½åŒ—çº¿ï¼ˆé½é½å“ˆå°”-å¯Œè£•ï¼‰.gpx', './railway/gpx_jr/JRä¸œæµ·é“çº¿ï¼ˆç±³åŸ-å¤§é˜ªï¼‰.gpx', './railway/gpx_jr/JRå…³è¥¿çº¿ï¼ˆä¹…å®å¯º-æŸ˜æ¤ï¼‰.gpx', './railway/gpx_jr/JRåŒ—é™†çº¿ï¼ˆç±³åŸ-æ•¦è´ºï¼‰.gpx', './railway/gpx_jr/JRå¤§é˜ªç¯çŠ¶çº¿.gpx', './railway/gpx_jr/JRå¥ˆè‰¯çº¿ï¼ˆäº¬éƒ½-æœ¨æ´¥ï¼‰.gpx', './railway/gpx_jr/JRå±±é˜³çº¿ï¼ˆä¸‰å®«-å§¬è·¯ï¼‰.gpx', './railway/gpx_jr/JRæ¹–è¥¿çº¿ï¼ˆå±±ç§‘-è¿‘æ±Ÿç›æ´¥ï¼‰.gpx', './railway/gpx_jr/JRçºªåŠ¿çº¿ï¼ˆå’Œæ­Œå±±-å’Œæ­Œå±±å¸‚ï¼‰.gpx', './railway/gpx_jr/JRè‰æ´¥çº¿ï¼ˆè‰æ´¥-æŸ˜æ¤ï¼‰.gpx', './railway/gpx_jr/JRé˜ªå’Œçº¿ï¼ˆå¤©ç‹å¯º-å’Œæ­Œå±±ï¼‰.gpx', './railway/gpx_jr/äº¬é˜ªæœ¬çº¿ï¼ˆæ·€å±‹æ¡¥-ä¸‰æ¡ï¼‰.gpx', './railway/gpx_jr/å—æµ·åŠ å¤ªçº¿ï¼ˆçºªä¹‹å·-åŠ å¤ªï¼‰.gpx', './railway/gpx_jr/å—æµ·æœ¬çº¿ï¼ˆæ–°ä»Šå®«-å’Œæ­Œå±±å¸‚ï¼‰.gpx', './railway/gpx_jr/å—æµ·æœºåœºçº¿ï¼ˆæ³‰ä½é‡-å…³è¥¿æœºåœºï¼‰.gpx', './railway/gpx_jr/è¿‘é“å¥ˆè‰¯çº¿ï¼ˆå¥ˆè‰¯-è¿‘é“æ—¥æœ¬æ¡¥ï¼‰.gpx', './railway/gpx_jr/é˜ªæ€¥å®å¡šçº¿ï¼ˆå¤§é˜ªæ¢…ç”°-åº„å†…ï¼‰.gpx', './railway/gpx_jr/é˜ªç¥æœ¬çº¿ï¼ˆé˜ªç¥ä¸‰å®«-é˜ªç¥å°¼å´ï¼‰.gpx', './railway/gpx_jr/é˜ªç¥éš¾æ³¢çº¿ï¼ˆé˜ªç¥å°¼å´-è¥¿ä¹æ¡ï¼‰.gpx']
    },
    // runs: { color: "blue", files: [
    //   "runs/morning_run_1.gpx",
    //   "runs/morning_run_2.gpx"
    // ]}
  };

  const icons = {
    flights: L.icon({
      iconUrl: "assets/airport.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    }),
    railway: L.icon({
      iconUrl: "assets/station.png",
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    })
  };

  const overlays = {};  // æ¯ä¸ªæ–‡ä»¶å¤¹ä¸€ç»„å›¾å±‚
  let globalBounds = null;

  for (const [folder, cfg] of Object.entries(groups)) {
    const layerGroup = L.layerGroup();
    overlays[folder] = layerGroup;  // è®© layer control å¯ä»¥æ§åˆ¶å¼€å…³

    cfg.files.forEach(file => {
      new L.GPX(file, {
        async: true,
        polyline_options: {
          color: cfg.color,
          weight: 4,
          opacity: 0.85
        },
        markers: {
          startIcon: null,
          endIcon: null,
          // shadowUrl: ''
        }
      })
      .on("loaded", e => {
        const g = e.target;
        const filename = file.split("/").pop(); // å–æ–‡ä»¶åéƒ¨åˆ†
        const match = filename.match(/_(\w+)_([0-9]{8})\.gpx$/);
        let displayName;

        if (match) {
          displayName = `${match[1]}-${match[2]}`;
        } else {
          displayName = filename.replace(".gpx", "");
        }

        g.bindPopup(`<b>${displayName}</b>`);

        // æ›´æ–°å…¨å±€è§†å›¾èŒƒå›´
        const b = g.getBounds();
        if (globalBounds) globalBounds.extend(b);
        else globalBounds = b;

        map.fitBounds(globalBounds, { padding: [20, 20] });
      })
      .addTo(layerGroup);
    });
  }

  // === åŠ è½½ç‹¬ç«‹ç‚¹ï¼ˆä»å¤–éƒ¨ JSONï¼‰===
  fetch("./flights/airport.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue; // æ²¡æœ‰å¯¹åº”ç»„åˆ™è·³è¿‡

        points.forEach(p => {
          const name = currentLang === "zh" ? p.name_zh : p.name_en;
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${name}</b>`)
            .addTo(group);
        // ä¸ºåç»­è¯­è¨€åˆ‡æ¢ä¿å­˜å¼•ç”¨
        marker._names = { zh: p.name_zh, en: p.name_en };
        if (!group._markers) group._markers = [];
          group._markers.push(marker);
        });
      }
    })
  .catch(err => console.error("åŠ è½½ airport.json å‡ºé”™:", err));

  fetch("./railway/station.json")
    .then(resp => resp.json())
    .then(data => {
      for (const [groupName, points] of Object.entries(data)) {
        const group = overlays[groupName];
        if (!group) continue; // æ²¡æœ‰å¯¹åº”ç»„åˆ™è·³è¿‡

        points.forEach(p => {
          const name = currentLang === "zh" ? p.name_zh : p.name_en;
          const marker = L.marker([p.lat, p.lon], { icon: icons[groupName] })
            .bindPopup(`<b>${name}</b>`)
            .addTo(group);
        // ä¸ºåç»­è¯­è¨€åˆ‡æ¢ä¿å­˜å¼•ç”¨
        marker._names = { zh: p.name_zh, en: p.name_en };
        if (!group._markers) group._markers = [];
          group._markers.push(marker);
        });
      }
    })
  .catch(err => console.error("åŠ è½½ station.json å‡ºé”™:", err));

  overlays["flights"].setZIndex(1000);
  overlays["railway"].setZIndex(500);

  L.control.layers(null, overlays, { collapsed: false }).addTo(map);

//   tracks.forEach(({ file, color }) => {
//     const gpx = new L.GPX(file, {
//       async: true,
//       polyline_options: { color, weight: 4, opacity: 0.8 },
//       markers: {
//         startIcon: null,
//         endIcon: null,
//         // wptIcons: null,
//       },
//     })
//       .on("loaded", (e) => {
//         const g = e.target;
//         const name = g.get_name() || file;
//         g.bindPopup(`<b>${name}</b>`);
// 
//         bounds.push(g.getBounds());
//         if (bounds.length === tracks.length) {
//           const all = bounds.reduce((b, cur) => b.extend(cur), bounds[0]);
//           map.fitBounds(all);
//         }
// 
//         g.eachLayer((layer) => {
//           if (layer instanceof L.Marker) {
//             map.removeLayer(layer);
//           }
//         });
//       })
//       .addTo(map);
//   });

  // è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–° Popup
  window.updateMarkerLang = function(lang) {
    if (!map._markers) return;
    map._markers.forEach(marker => {
      marker.bindPopup(`<b>${marker._names[lang]}</b>`);
    });
  };

  // ç›‘å¬è¯­è¨€å˜åŒ–å¹¶æ›´æ–° popup
  window.addEventListener("storage", e => {
    if (e.key === "lang") {
      loadLanguage(e.newValue);
      updateMarkerLang(e.newValue);
    }
  });
</script>

</body>
</html>
